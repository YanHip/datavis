<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Data Visualisation</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
			integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
			crossorigin="anonymous"
		/>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
			crossorigin="anonymous"
		></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<link rel="stylesheet" href="./index.css" />
	</head>

	<header>
		<h2>Visualisation de données sur les films et séries présentent sur Netflix</h2>
	</header>

	<body>
		<div class="container-sm params_div">
			<div class="form-group">
				<label for="select_visu">Choix du type de visuel:</label>
				<select class="form-control" id="select_visu">
					<option value="2">Les 2</option>
					<option value="0">Film</option>
					<option value="1">Série</option>
				</select>
			</div>
		</div>
		<div class="container-sm visu_div">
			<div id="my_dataviz"></div>
		</div>
	</body>
	<script>
		var global_var = {
			url: "./csvNetflixData.csv",
		};

		document.getElementById("select_visu").onchange = function (e) {
			main(e.target.value);
		};

		main(2);

		function main(type_of_visu) {
			document.getElementById("my_dataviz").innerHTML = "";
			let nbXAxe = 300;
			if (type_of_visu == 1) {
				nbXAxe = 20;
			}

			var margin = { top: 10, right: 30, bottom: 30, left: 60 },
				width = 1000 - margin.left - margin.right,
				height = 450 - margin.top - margin.bottom;

			var svg = d3
				.select("#my_dataviz")
				.append("svg")
				.attr("width", width + margin.left + margin.right + 200)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			//Read the data
			d3.csv(global_var.url, function (data) {
				var x = d3.scaleLinear().domain([0, nbXAxe]).range([0, width]);
				svg
					.append("g")
					.attr("transform", "translate(0," + height + ")")
					.call(d3.axisBottom(x));

				let text = "Durée (en min ou en saison)";
				if (type_of_visu == 0) {
					text = "Durée (en min)";
				} else if (type_of_visu == 1) {
					text = "Durée (en saison)";
				}

				svg
					.append("text")
					.attr("class", "x label")
					.attr("text-anchor", "end")
					.attr("x", width + 100)
					.attr("y", height - 6)
					.text(text);

				var y = d3.scaleLinear().domain([0, 10]).range([height, 10]);
				svg.append("g").call(d3.axisLeft(y));

				svg.append("text").attr("class", "y label").attr("text-anchor", "end").attr("x", 20).attr("y", -10).attr("dy", ".75em").text("Note imdb");

				var tooltip = d3
					.select("#my_dataviz")
					.append("div")
					.style("opacity", 0)
					.attr("class", "tooltip")
					.style("background-color", "white")
					.style("border", "solid")
					.style("border-width", "1px")
					.style("border-radius", "5px")
					.style("padding", "10px");

				var mouseover = function (d) {
					tooltip
						.html("Le film " + d.title_x + " dure " + d.duration + " et est noté " + d.imdb_rating)
						.style("left", d3.mouse(this)[0] + 90 + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
						.style("top", d3.mouse(this)[1] + "px");
					tooltip.style("opacity", 1);
				};

				var mousemove = function (d) {
					tooltip
						.html("Le film " + d.title_x + " dure " + d.duration + " et est noté " + d.imdb_rating)
						.style("left", d3.mouse(this)[0] + 90 + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
						.style("top", d3.mouse(this)[1] + "px");
					tooltip.style("opacity", 1);
				};

				var mouseleave = function (d) {
					tooltip.transition().duration(200).style("opacity", 0);
				};

				var mouseclick = function (d) {
					url = "http://www.google.com/search?q=" + d.title_x;
					window.open(url, "_blank");
				};

				let unity_of_duration = [];
				svg
					.append("g")
					.selectAll("dot")
					.data(data)
					.enter()
					.append("circle")
					.attr("cx", function (d) {
						if (d.imdb_rating != "" && d.imdb_rating != null) {
							let duree = d.duration.split(" ");
							if (!unity_of_duration.includes(d.type)) unity_of_duration.push(d.type);
							if (type_of_visu == 0 && d.type == "Movie") {
								return x(duree[0]);
							} else if (type_of_visu == 1 && d.type == "TV Show") {
								return x(duree[0]);
							} else if (type_of_visu == 2) {
								return x(duree[0]);
							}
						}
					})
					.attr("cy", function (d) {
						if (d.imdb_rating != "" && d.imdb_rating != null) {
							if (type_of_visu == 0 && d.type == "Movie") {
								return y(d.imdb_rating);
							} else if (type_of_visu == 1 && d.type == "TV Show") {
								return y(d.imdb_rating);
							} else if (type_of_visu == 2) {
								return y(d.imdb_rating);
							} else {
								return y(-1000);
							}
						} else {
							return y(-1000);
						}
					})
					.attr("r", 4)
					.style("fill", "#69b3a2")
					.style("opacity", 0.7)
					.style("stroke", "white")
					.on("mouseover", mouseover)
					.on("mousemove", mousemove)
					.on("mouseleave", mouseleave)
					.on("click", mouseclick);
			});
		}
	</script>
</html>
